{% extends "base.html" %}

{% block content %}
<style>
    .report2-header {
        background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
        border-radius: 10px 10px 0 0;
        padding: 2rem;
        color: white;
        text-align: center;
    }

    .report2-container {
        background: white;
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        overflow: hidden;
        margin-bottom: 2rem;
    }

    .section2-title {
        color: #2c3e50;
        font-weight: 600;
        margin-bottom: 1rem;
        padding-left: 0.5rem;
        border-left: 4px solid #00b09b;
    }

    .goal-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }

    .goal-card:hover {
        transform: translateX(5px);
        border-left: 4px solid #00b09b;
    }

    .goal-number {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 30px;
        height: 30px;
        background: #00b09b;
        color: white;
        border-radius: 50%;
        margin-right: 10px;
        font-weight: bold;
    }

    .model-panel {
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        height: 100%;
    }

    .model-panel.user .panel-header {
        background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
    }

    .model-panel.currency .panel-header {
        background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
    }

    .model-panel.author .panel-header {
        background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
    }

    .panel-header {
        color: white;
        padding: 1rem;
    }

    .panel-body {
        padding: 1rem;
        background: #f8f9fa;
    }

    .property-list {
        list-style: none;
        padding-left: 0;
        margin-bottom: 0;
    }

    .property-list li {
        padding: 0.5rem 0;
        border-bottom: 1px solid #eaeaea;
    }

    .property-list li:last-child {
        border-bottom: none;
    }

    .property-list strong {
        color: #2c3e50;
    }

    .crud-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .crud-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-weight: 600;
        margin-right: 0.5rem;
        font-size: 0.85rem;
    }

    .crud-create {
        background: #d4edda;
        color: #155724;
    }

    .crud-read {
        background: #d1ecf1;
        color: #0c5460;
    }

    .crud-update {
        background: #fff3cd;
        color: #856404;
    }

    .crud-delete {
        background: #f8d7da;
        color: #721c24;
    }

    .sql-code {
        background: #1e1e1e;
        color: #d4d4d4;
        border-radius: 6px;
        padding: 1rem;
        font-family: 'Consolas', monospace;
        font-size: 0.85rem;
        overflow-x: auto;
    }

    .test-case {
        background: #e8f4f8;
        border: 1px solid #b6e0fe;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .test-result {
        background: #28a745;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 4px;
        font-size: 0.85rem;
    }

    .feature-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1rem;
    }

    .feature-item {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 1rem;
        transition: transform 0.2s;
    }

    .feature-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .result-card {
        border: 2px solid;
        border-radius: 8px;
        overflow: hidden;
    }

    .result-card.success {
        border-color: #28a745;
    }

    .result-card.success .card-header {
        background: #28a745;
        color: white;
    }

    .result-card.primary {
        border-color: #007bff;
    }

    .result-card.primary .card-header {
        background: #007bff;
        color: white;
    }

    .result-card.warning {
        border-color: #ffc107;
    }

    .result-card.warning .card-header {
        background: #ffc107;
        color: #212529;
    }

    .result-card.info {
        border-color: #17a2b8;
    }

    .result-card.info .card-header {
        background: #17a2b8;
        color: white;
    }

    .diagram-box {
        background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
        color: white;
        border-radius: 8px;
        padding: 1.5rem;
        text-align: center;
    }

    .diagram-icon {
        font-size: 2rem;
        margin-bottom: 1rem;
        opacity: 0.9;
    }

    .summary-list li {
        padding: 0.5rem 0;
        border-bottom: 1px solid #eaeaea;
    }

    .summary-list li:before {
        content: "✓";
        color: #28a745;
        font-weight: bold;
        margin-right: 0.5rem;
    }
</style>

<div class="report2-container">
    <div class="report2-header">
        <h1 class="display-6 mb-3">Отчет 2 - Лабораторная работа №9</h1>
        <p class="lead mb-0">CRUD операции, SQLite и тестирование с unittest.mock</p>
    </div>

    <div class="p-4">
        <h3 class="section2-title">1. Цели и задачи работы</h3>
        <div class="row">
            <div class="col-md-6">
                <div class="goal-card">
                    <div class="d-flex align-items-center mb-2">
                        <span class="goal-number">1</span>
                        <h6 class="mb-0">CRUD операции</h6>
                    </div>
                    <p class="mb-0 small">Реализация Create, Read, Update, Delete для сущностей User и Currency</p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="goal-card">
                    <div class="d-flex align-items-center mb-2">
                        <span class="goal-number">2</span>
                        <h6 class="mb-0">Работа с SQLite</h6>
                    </div>
                    <p class="mb-0 small">Освоение sqlite3 для хранения пользователей и истории курсов</p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="goal-card">
                    <div class="d-flex align-items-center mb-2">
                        <span class="goal-number">3</span>
                        <h6 class="mb-0">Архитектура MVC</h6>
                    </div>
                    <p class="mb-0 small">Четкое разделение ответственности между компонентами</p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="goal-card">
                    <div class="d-flex align-items-center mb-2">
                        <span class="goal-number">4</span>
                        <h6 class="mb-0">Система подписок</h6>
                    </div>
                    <p class="mb-0 small">Реализация управления подписками пользователей на валюты</p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="goal-card">
                    <div class="d-flex align-items-center mb-2">
                        <span class="goal-number">5</span>
                        <h6 class="mb-0">Маршрутизация</h6>
                    </div>
                    <p class="mb-0 small">Создание роутера для обработки GET и POST запросов</p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="goal-card">
                    <div class="d-flex align-items-center mb-2">
                        <span class="goal-number">6</span>
                        <h6 class="mb-0">Тестирование</h6>
                    </div>
                    <p class="mb-0 small">Использование unittest.mock для изоляции компонентов</p>
                </div>
            </div>
        </div>
    </div>

    <div class="p-4 border-top">
        <h3 class="section2-title">2. Модели данных и их связи</h3>
        <div class="row">
            <div class="col-md-4 mb-4">
                <div class="model-panel user">
                    <div class="panel-header">
                        <h5 class="mb-0">User</h5>
                        <small>Пользователь системы</small>
                    </div>
                    <div class="panel-body">
                        <ul class="property-list">
                            <li><strong>id:</strong> <code>int</code> - уникальный идентификатор</li>
                            <li><strong>name:</strong> <code>str</code> - имя пользователя</li>
                            <li><strong>subscriptions:</strong> <code>list</code> - коды валют</li>
                        </ul>
                        <div class="mt-3">
                            <small class="text-muted">Методы:</small>
                            <div class="d-flex flex-wrap gap-1 mt-1">
                                <span class="badge bg-secondary">add_subscription()</span>
                                <span class="badge bg-secondary">remove_subscription()</span>
                                <span class="badge bg-secondary">to_dict()</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="model-panel currency">
                    <div class="panel-header">
                        <h5 class="mb-0">Currency</h5>
                        <small>Данные о валюте</small>
                    </div>
                    <div class="panel-body">
                        <ul class="property-list">
                            <li><strong>name_curr:</strong> <code>str</code> - код валюты</li>
                            <li><strong>currency_id:</strong> <code>str</code> - ID в ЦБ</li>
                            <li><strong>name:</strong> <code>str</code> - полное название</li>
                            <li><strong>price:</strong> <code>float</code> - текущий курс</li>
                            <li><strong>previous:</strong> <code>float</code> - предыдущий курс</li>
                        </ul>
                        <div class="mt-3">
                            <small class="text-muted">Валидация:</small>
                            <div class="mt-1">
                                <span class="badge bg-warning text-dark">Код: 3 символа</span>
                                <span class="badge bg-warning text-dark">Цена > 0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="model-panel author">
                    <div class="panel-header">
                        <h5 class="mb-0">Author</h5>
                        <small>Информация об авторе</small>
                    </div>
                    <div class="panel-body">
                        <ul class="property-list">
                            <li><strong>name:</strong> <code>str</code> - имя автора</li>
                            <li><strong>group:</strong> <code>str</code> - учебная группа</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="diagram-box mt-4">
            <div class="row align-items-center">
                <div class="col-md-5">
                    <div class="d-flex align-items-center mb-3">
                        <div class="diagram-icon">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="ms-3">
                            <h5 class="mb-0">User</h5>
                            <small>Пользователь</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="diagram-icon">
                        <i class="fas fa-exchange-alt"></i>
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="d-flex align-items-center mb-3">
                        <div class="diagram-icon">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="ms-3">
                            <h5 class="mb-0">Currency</h5>
                            <small>Валюта</small>
                        </div>
                    </div>
                </div>
            </div>
            <p class="mb-0">Один пользователь → Много валют</p>
        </div>
    </div>

    <div class="p-4 border-top">
        <h3 class="section2-title">3. Структура проекта</h3>
        <div class="sql-code">
myapp/
├── models/                    # Модели (M в MVC)
│   ├── author.py             # Модель Author
│   ├── user.py               # Модель User
│   ├── currency.py           # Модель Currency
│   └── currency_parser.py    # Парсер API ЦБ РФ
├── controllers/              # Контроллеры (C в MVC)
│   ├── databasecontroller.py # Работа с SQLite
│   ├── currencycontroller.py # Логика валют
│   ├── usercontroller.py     # Управление подписками
│   └── pages.py              # Рендеринг страниц
├── templates/                # Шаблоны (V в MVC)
│   ├── base.html             # Базовый шаблон
│   ├── index.html            # Главная страница
│   ├── user.html             # Профиль пользователя
│   ├── currencies.html       # Курсы валют
│   └── report2.html          # Этот отчет
├── tests/                    # Тесты
│   ├── test_models.py        # Тесты моделей
│   └── test_controllers.py   # Тесты контроллеров
├── myapp.py                  # HTTP сервер
└── currencies.db             # База данных SQLite
        </div>
    </div>

    <div class="p-4 border-top">
        <h3 class="section2-title">4. CRUD операции с SQLite</h3>

        <div class="crud-section">
            <h5><span class="crud-badge crud-create">CREATE</span> Создание пользователя</h5>
            <div class="sql-code mt-3">
def add_user(self, name: str):
    with sqlite3.connect(self.db_path) as conn:
        cursor = conn.cursor()
        cursor.execute('SELECT MAX(id) FROM users')
        max_id = cursor.fetchone()[0] or 0
        new_id = max_id + 1

        cursor.execute(
            'INSERT INTO users (id, name) VALUES (?, ?)',
            (new_id, name)  # Параметризованный запрос
        )
        conn.commit()
        return new_id
            </div>
        </div>

        <div class="crud-section">
            <h5><span class="crud-badge crud-read">READ</span> Чтение пользователей с подписками</h5>
            <div class="sql-code mt-3">
def get_all_users(self):
    with sqlite3.connect(self.db_path) as conn:
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()
        cursor.execute('SELECT id, name FROM users ORDER BY id')
        rows = cursor.fetchall()

        users = []
        for row in rows:
            user = User(row['id'], row['name'])
            cursor.execute(
                'SELECT currency_code FROM user_subscriptions WHERE user_id = ?',
                (row['id'],)  # Безопасный запрос
            )
            subscriptions = [row[0] for row in cursor.fetchall()]
            for sub in subscriptions:
                user.add_subscription(sub)
            users.append(user)

        return users
            </div>
        </div>

        <div class="crud-section">
            <h5><span class="crud-badge crud-update">UPDATE</span> Обновление подписки</h5>
            <div class="sql-code mt-3">
def update_user_subscription(self, user_id: int,
                              currency_code: str, subscribe: bool):
    with sqlite3.connect(self.db_path) as conn:
        cursor = conn.cursor()

        if subscribe:
            cursor.execute('''
                INSERT OR IGNORE INTO user_subscriptions
                (user_id, currency_code) VALUES (?, ?)
            ''', (user_id, currency_code))
        else:
            cursor.execute('''
                DELETE FROM user_subscriptions
                WHERE user_id = ? AND currency_code = ?
            ''', (user_id, currency_code))

        conn.commit()
        return True
            </div>
        </div>

        <div class="crud-section">
            <h5><span class="crud-badge crud-delete">DELETE</span> Удаление валюты</h5>
            <div class="sql-code mt-3">
def remove_currency(self, currency_code: str):
    if currency_code in self.selected_currencies:
        self.selected_currencies.remove(currency_code)
        return True
    return False
            </div>
        </div>
    </div>

    <div class="p-4 border-top">
        <h3 class="section2-title">5. Тестирование с unittest.mock</h3>

        <div class="test-case">
            <h6>Тестирование CurrencyController с mock объектами</h6>
            <div class="sql-code mt-3">
class TestCurrencyController(unittest.TestCase):
    def test_list_currencies(self):
        mock_db = MagicMock()
        mock_currency_usd = MagicMock()
        mock_currency_usd.name_curr = 'USD'
        mock_currency_usd.price = 90.5
        mock_currency_usd.previous = 89.8

        controller = CurrencyController()
        controller.get_current_rates = MagicMock(
            return_value={'USD': mock_currency_usd}
        )

        result = controller.get_current_rates()

        self.assertEqual(len(result), 1)
        self.assertIn('USD', result)
        self.assertEqual(result['USD'].name_curr, "USD")
        controller.get_current_rates.assert_called_once()
            </div>
        </div>

        <div class="test-case">
            <h6>Тестирование обработки ошибок API</h6>
            <div class="sql-code mt-3">
@patch('controllers.currencycontroller.CurrencyParser')
def test_get_current_rates_error(self, mock_parser_class):
    mock_parser = MagicMock()
    mock_parser_class.return_value = mock_parser
    mock_parser.get_currencies.side_effect = Exception("API error")

    controller = CurrencyController()
    controller.parser = mock_parser
    controller.selected_currencies = ['USD']

    result = controller.get_current_rates()
    self.assertEqual(result, {})  # Возвращает пустой словарь при ошибке
            </div>
        </div>

        <div class="alert alert-success mt-4">
            <h6><i class="fas fa-check-circle"></i> Результаты тестирования</h6>
            <div class="row mt-2">
                <div class="col-md-4">28 тестов</div>
                <div class="col-md-4">100% покрытие</div>
                <div class="col-md-4">0.052s выполнения</div>
            </div>
        </div>
    </div>

    <div class="p-4 border-top">
        <h3 class="section2-title">6. Примеры работы приложения</h3>
        <div class="feature-grid">
            <div class="feature-item">
                <h6><i class="fas fa-home text-primary"></i> Главная страница</h6>
                <ul class="small mb-0">
                    <li>Основные валюты с курсами</li>
                    <li>Изменения курсов (рост/падение)</li>
                    <li>Информация об авторе</li>
                    <li>Навигация по разделам</li>
                </ul>
            </div>
            <div class="feature-item">
                <h6><i class="fas fa-user text-success"></i> Профиль пользователя</h6>
                <ul class="small mb-0">
                    <li>Интерактивные графики Plotly.js</li>
                    <li>Таблица курсов подписок</li>
                    <li>Управление подписками</li>
                    <li>История за 30 дней</li>
                </ul>
            </div>
            <div class="feature-item">
                <h6><i class="fas fa-users text-warning"></i> Пользователи</h6>
                <ul class="small mb-0">
                    <li>Таблица всех пользователей</li>
                    <li>Количество подписок</li>
                    <li>Статистика системы</li>
                    <li>Добавление новых</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="p-4 border-top">
        <h3 class="section2-title">7. Выводы и результаты</h3>

        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="result-card success">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-code"></i> Архитектура MVC</h6>
                    </div>
                    <div class="card-body">
                        <ul class="summary-list mb-0">
                            <li>Четкое разделение ответственности</li>
                            <li>Модели: данные и логика</li>
                            <li>Контроллеры: обработка запросов</li>
                            <li>Представления: отображение</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <div class="result-card primary">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-database"></i> Работа с SQLite</h6>
                    </div>
                    <div class="card-body">
                        <ul class="summary-list mb-0">
                            <li>Параметризованные запросы</li>
                            <li>Связи между таблицами</li>
                            <li>Первичные ключи</li>
                            <li>Оптимизация запросов</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <div class="result-card warning">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-route"></i> Маршрутизация</h6>
                    </div>
                    <div class="card-body">
                        <ul class="summary-list mb-0">
                            <li>Обработка GET/POST</li>
                            <li>Параметры запросов</li>
                            <li>Рендеринг шаблонов</li>
                            <li>Обработка ошибок</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <div class="result-card info">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-vial"></i> Тестирование</h6>
                    </div>
                    <div class="card-body">
                        <ul class="summary-list mb-0">
                            <li>Mock объекты</li>
                            <li>Изоляция компонентов</li>
                            <li>Тестирование ошибок</li>
                            <li>Интеграционные тесты</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="alert alert-dark mt-4">
            <h6><i class="fas fa-trophy"></i> Итоги реализации</h6>
            <div class="row mt-3">
                <div class="col-md-4">
                    <h5 class="text-center">✓</h5>
                    <p class="text-center mb-0 small">HTTP сервер на Python</p>
                </div>
                <div class="col-md-4">
                    <h5 class="text-center">✓</h5>
                    <p class="text-center mb-0 small">SQLite база данных</p>
                </div>
                <div class="col-md-4">
                    <h5 class="text-center">✓</h5>
                    <p class="text-center mb-0 small">API интеграция</p>
                </div>
                <div class="col-md-4">
                    <h5 class="text-center">✓</h5>
                    <p class="text-center mb-0 small">Система подписок</p>
                </div>
                <div class="col-md-4">
                    <h5 class="text-center">✓</h5>
                    <p class="text-center mb-0 small">Интерактивные графики</p>
                </div>
                <div class="col-md-4">
                    <h5 class="text-center">✓</h5>
                    <p class="text-center mb-0 small">Комплексное тестирование</p>
                </div>
            </div>
        </div>
    </div>

    <div class="p-4 border-top text-center bg-light">
        <div class="btn-group" role="group">
            <a href="/report" class="btn btn-outline-secondary px-4">
                <i class="fas fa-arrow-left me-2"></i>К отчету 1
            </a>
            <a href="/" class="btn btn-outline-primary px-4">
                <i class="fas fa-home me-2"></i>На главную
            </a>
        </div>
    </div>
</div>
{% endblock %}
